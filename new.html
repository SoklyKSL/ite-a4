<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Live Video Capture: Paper Signature + Thumb Presence</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 16px; }
    .wrap { max-width: 980px; margin: 0 auto; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 12px; margin-top: 12px; }
    video { width: 100%; border-radius: 12px; background: #111; }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top: 10px; }
    button { padding: 10px 12px; border-radius: 10px; border: 1px solid #ccc; background:#fff; cursor:pointer; }
    button:disabled { opacity:.5; cursor:not-allowed; }
    .status { font-weight: 650; }
    .small { font-size: 12px; color: #444; }
    .pill { padding: 6px 10px; border:1px solid #ddd; border-radius:999px; }
  </style>
</head>
<body>
<div class="wrap">
  <h2>Record ONE Live Video: Physical Signature + Thumb</h2>
  <p class="small">
    This records a single clip that contains both: (1) the signed paper and (2) the user showing thumb.
  </p>

  <div class="card">
    <video id="preview" playsinline></video>

    <div class="row">
      <button id="btnStartCam">Start camera</button>
      <button id="btnStartRec" disabled>Start recording</button>
      <button id="btnStopRec" disabled>Stop recording</button>
      <span class="pill" id="stepPill">Step: idle</span>
      <span class="status" id="status">Status: idle</span>
    </div>

    <div class="row">
      <button id="btnStep1" disabled>Step 1: Signed paper</button>
      <button id="btnStep2" disabled>Step 2: Thumb</button>
    </div>

    <p class="small">
      Tip: use the back camera for clearer paper. Works best on Chrome/Edge (Android/Desktop).
      iOS Safari MediaRecorder support varies by iOS version.
    </p>
  </div>

  <div class="card">
    <h3>Recorded Video</h3>
    <video id="playback" controls></video>
    <div class="row">
      <button id="btnDownload" disabled>Download video</button>
    </div>
  </div>
</div>

<!-- MediaPipe Hands -->
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.min.js"></script>

<script>
  const preview = document.getElementById("preview");
  const playback = document.getElementById("playback");

  const btnStartCam = document.getElementById("btnStartCam");
  const btnStartRec = document.getElementById("btnStartRec");
  const btnStopRec  = document.getElementById("btnStopRec");
  const btnDownload = document.getElementById("btnDownload");

  const btnStep1 = document.getElementById("btnStep1");
  const btnStep2 = document.getElementById("btnStep2");

  const statusEl = document.getElementById("status");
  const stepPill = document.getElementById("stepPill");

  let stream = null;
  let recorder = null;
  let chunks = [];
  let recordedBlob = null;

  // MediaPipe
  let hands = null;
  let mpCamera = null;

  let step = "idle"; // "paper" | "thumb"
  function setStep(s) {
    step = s;
    if (s === "paper") stepPill.textContent = "Step: show signed paper";
    else if (s === "thumb") stepPill.textContent = "Step: show thumb";
    else stepPill.textContent = "Step: idle";
  }

  function pickBestMime() {
    const candidates = [
      "video/webm;codecs=vp9,opus",
      "video/webm;codecs=vp8,opus",
      "video/webm"
    ];
    for (const t of candidates) {
      if (window.MediaRecorder && MediaRecorder.isTypeSupported(t)) return t;
    }
    return ""; // let browser decide
  }

  async function startCamera() {
    if (!navigator.mediaDevices?.getUserMedia) {
      alert("getUserMedia not supported in this browser.");
      return;
    }

    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }, // back cam for paper
      audio: true
    });

    preview.srcObject = stream;
    await preview.play();

    // Setup MediaPipe Hands (for thumb presence status only)
    hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 1,
      minDetectionConfidence: 0.6,
      minTrackingConfidence: 0.6
    });

    hands.onResults((res) => {
      // Only care in thumb step
      if (step !== "thumb") return;

      const hasHand = !!(res.multiHandLandmarks && res.multiHandLandmarks.length);
      if (!hasHand) {
        statusEl.textContent = "Status: (thumb step) no hand detected";
        return;
      }
      // Thumb tip landmark exists if hand exists
      statusEl.textContent = "Status: (thumb step) thumb/hand detected ✅";
    });

    // Drive frames to MediaPipe
    mpCamera = new Camera(preview, {
      onFrame: async () => { await hands.send({ image: preview }); },
      width: 640,
      height: 480
    });
    mpCamera.start();

    btnStartRec.disabled = false;
    btnStep1.disabled = false;
    btnStep2.disabled = false;
    btnStartCam.disabled = true;

    setStep("paper");
    statusEl.textContent = "Status: camera ready";
  }

  function startRecording() {
    if (!stream) return;

    chunks = [];
    recordedBlob = null;
    playback.removeAttribute("src");
    btnDownload.disabled = true;

    const mimeType = pickBestMime();
    recorder = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);

    recorder.ondataavailable = (e) => {
      if (e.data && e.data.size > 0) chunks.push(e.data);
    };

    recorder.onstop = () => {
      recordedBlob = new Blob(chunks, { type: recorder.mimeType || "video/webm" });
      const url = URL.createObjectURL(recordedBlob);
      playback.src = url;
      btnDownload.disabled = false;
      statusEl.textContent = "Status: recorded ✅ (ready to download)";
    };

    recorder.start(250); // collect data every 250ms
    btnStartRec.disabled = true;
    btnStopRec.disabled = false;
    statusEl.textContent = "Status: recording...";
    setStep("paper"); // start with paper
  }

  function stopRecording() {
    if (recorder && recorder.state !== "inactive") recorder.stop();
    btnStopRec.disabled = true;
    btnStartRec.disabled = false;
    setStep("idle");
  }

  function downloadVideo() {
    if (!recordedBlob) return;
    const url = URL.createObjectURL(recordedBlob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "signature_and_thumb_video.webm";
    document.body.appendChild(a);
    a.click();
    a.remove();
    // keep url around for playback; don't revoke immediately
  }

  // UI actions
  btnStartCam.onclick = () => startCamera().catch(err => {
    console.error(err);
    alert("Camera start failed: " + err.message);
  });

  btnStartRec.onclick = () => startRecording();
  btnStopRec.onclick = () => stopRecording();

  btnStep1.onclick = () => {
    setStep("paper");
    statusEl.textContent = "Status: show the signed paper clearly in frame";
  };

  btnStep2.onclick = () => {
    setStep("thumb");
    statusEl.textContent = "Status: show your thumb close to the camera";
  };

  btnDownload.onclick = () => downloadVideo();
</script>
</body>
</html>
