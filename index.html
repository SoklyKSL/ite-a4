<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sign + Record Face</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 16px; max-width: 800px; margin: 0 auto; }
    .row { display: flex; gap: 16px; flex-wrap: wrap; align-items: flex-start; }
    video { width: 260px; border: 1px solid #ccc; border-radius: 8px; }
    canvas { border: 1px solid #ccc; border-radius: 8px; touch-action: none; }
    button { padding: 10px 14px; margin-right: 8px; }
    .status { margin-top: 10px; color: #333; }
    .small { font-size: 12px; color: #666; }
  </style>
</head>
<body>
  <h2>Sign while recording face</h2>
  <div class="row">
    <div>
      <div class="small">Webcam preview (face evidence)</div>
      <video id="preview" autoplay playsinline muted></video>
      <div class="status" id="recStatus">Camera: not started</div>
    </div>

    <div>
      <div class="small">Signature pad</div>
      <canvas id="sig" width="480" height="220"></canvas>
      <div style="margin-top:10px;">
        <button id="start">Start signing</button>
        <button id="clear" disabled>Clear signature</button>
        <button id="finish" disabled>Finish</button>
      </div>
      <div class="status" id="sigStatus">Signature: empty</div>
    </div>
  </div>

  <hr />
  <!-- <div class="small">
    Upload demo: this example prints sizes to console. To upload, connect the FormData to your backend endpoint.
  </div> -->

<script>
  const video = document.getElementById("preview");
  const canvas = document.getElementById("sig");
  const ctx = canvas.getContext("2d");
  const startBtn = document.getElementById("start");
  const clearBtn = document.getElementById("clear");
  const finishBtn = document.getElementById("finish");
  const recStatus = document.getElementById("recStatus");
  const sigStatus = document.getElementById("sigStatus");

  // -------- Signature drawing (simple, no library) --------
  let drawing = false;
  let hasSignature = false;

  function getPos(e) {
    const r = canvas.getBoundingClientRect();
    const x = (e.clientX - r.left) * (canvas.width / r.width);
    const y = (e.clientY - r.top) * (canvas.height / r.height);
    return { x, y };
  }

  function startDraw(e) {
    drawing = true;
    const { x, y } = getPos(e);
    ctx.beginPath();
    ctx.moveTo(x, y);
    // Start recording on first stroke (if not started yet)
    startRecordingOnce();
  }

  function moveDraw(e) {
    if (!drawing) return;
    const { x, y } = getPos(e);
    ctx.lineWidth = 2;
    ctx.lineCap = "round";
    ctx.lineJoin = "round";
    ctx.strokeStyle = "#111";
    ctx.lineTo(x, y);
    ctx.stroke();
    hasSignature = true;
    sigStatus.textContent = "Signature: drawing...";
  }

  function endDraw() {
    drawing = false;
    if (hasSignature) sigStatus.textContent = "Signature: captured";
  }

  canvas.addEventListener("pointerdown", (e) => { if (!finishBtn.disabled) startDraw(e); });
  canvas.addEventListener("pointermove", (e) => { if (!finishBtn.disabled) moveDraw(e); });
  canvas.addEventListener("pointerup", endDraw);
  canvas.addEventListener("pointercancel", endDraw);

  function clearSignature() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    hasSignature = false;
    sigStatus.textContent = "Signature: empty";
  }

  // -------- Webcam recording --------
  let stream = null;
  let recorder = null;
  let chunks = [];
  let recordingStarted = false;

  async function startCamera() {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "user" }, // front camera on mobile
      audio: false // set true if you also want voice evidence
    });
    video.srcObject = stream;

    // Pick a supported mimeType
    const preferred = [
      "video/webm;codecs=vp9",
      "video/webm;codecs=vp8",
      "video/webm"
    ];
    let mimeType = "";
    for (const t of preferred) {
      if (MediaRecorder.isTypeSupported(t)) { mimeType = t; break; }
    }

    recorder = new MediaRecorder(stream, mimeType ? { mimeType } : undefined);
    recorder.ondataavailable = (e) => { if (e.data && e.data.size) chunks.push(e.data); };

    recStatus.textContent = "Camera: ready (recording will start when signing begins)";
  }

  function startRecordingOnce() {
    if (!recorder || recordingStarted) return;
    recordingStarted = true;
    chunks = [];
    recorder.start();
    recStatus.textContent = "Camera: recordingâ€¦";
  }

  function stopRecording() {
    return new Promise((resolve) => {
      if (!recorder || !recordingStarted) return resolve(null);
      recorder.onstop = () => {
        const blob = new Blob(chunks, { type: recorder.mimeType || "video/webm" });
        resolve(blob);
      };
      recorder.stop();
    });
  }

  function stopCamera() {
    if (stream) stream.getTracks().forEach(t => t.stop());
    stream = null;
  }

  // -------- Buttons --------
  startBtn.onclick = async () => {
    startBtn.disabled = true;
    clearBtn.disabled = false;
    finishBtn.disabled = false;

    // Must be triggered by user click to pass browser permission rules
    try {
      await startCamera();
    } catch (err) {
      recStatus.textContent = "Camera: permission denied or not available";
      console.error(err);
    }
  };

  clearBtn.onclick = () => clearSignature();

  finishBtn.onclick = async () => {
    if (!hasSignature) {
      alert("Please sign before finishing.");
      return;
    }

    finishBtn.disabled = true;
    clearBtn.disabled = true;

    // 1) Get signature image
    const signaturePngDataUrl = canvas.toDataURL("image/png");

    // 2) Stop recording & camera
    const videoBlob = await stopRecording();
    stopCamera();

    recStatus.textContent = "Camera: stopped";
    sigStatus.textContent = "Signature: finalized";

    // 3) Prepare upload payload
    const form = new FormData();
    form.append("signature_png", signaturePngDataUrl); // or convert to Blob if you prefer
    if (videoBlob) form.append("signing_video", videoBlob, "signing.webm");

    // Example: print sizes
    console.log("Signature PNG length:", signaturePngDataUrl.length);
    console.log("Video blob bytes:", videoBlob ? videoBlob.size : 0);

    // 4) Upload to server (uncomment + set your endpoint)
    // await fetch("/api/signing/complete", { method: "POST", body: form });

    alert("Captured signature + video. Check console logs.");
  };
</script>
</body>
</html>
